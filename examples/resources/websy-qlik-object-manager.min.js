"use strict";var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var WebsyQlikObjectManager=function(){function n(e,t){_classCallCheck(this,n);if(this.apps={},this.supportedChartTypes=[],this.chartLibrary={},this.connectedCallback=t,e.visualisationPlugins&&0<e.visualisationPlugins.length)for(var i=0;i<e.visualisationPlugins.length;i++)this.registerVisualisation(e.visualisationPlugins[i].id,e.visualisationPlugins[i].definition);this.options=Object.assign({},{api:"engine"},e),this.connectToApps()}return _createClass(n,[{key:"connectToApps",value:function(){var t=this,i=0,e="connectWithEngineAPI";"capability"==this.options.api&&(e="connectWithCapabilityAPI");for(var n=0;n<this.options.apps.length;n++)this[e](this.options.apps[n],function(e){e?t.connectedCallback(e):++i==t.options.apps.length&&(t.connectedCallback(null),t.options.defaultView&&""!==t.options.defaultView&&t.loadObjects(t.options.defaultView))})}},{key:"connectWithCapabilityAPI",value:function(t,i){var n=this,a=t.id;t.id=this.normalizeId(t.id),"undefined"!=typeof require?(require.config({baseUrl:(!0===t.isSecure?"https":"http")+"://"+t.host+":"+t.port+t.prefix+"resources"}),require(["js/qlik"],function(e){n.apps[t.id]=e.openApp(a,t),i()})):i({error:"RequireJs not found."})}},{key:"connectWithEngineAPI",value:function(t,i){var n=this,a=t.id;if(t.id=this.normalizeId(t.id),"undefined"!=typeof enigma){var e={schema:this.options.enigmaSchema,url:(!0===t.isSecure?"wss":"ws")+"://"+t.host+":"+t.port+t.prefix+"app/"+t.id};enigma.create(e).open().then(function(e){e.openDoc(a).then(function(e){n.apps[t.id]=e,i()})})}else i({error:"Enigma.js not found."})}},{key:"loadObjects",value:function(e){var t=this.options.views[e];if(t&&0<t.length)for(var i=0;i<t.length;i++)"engine"===this.options.api?t[i].objectId?(t[i].attached=!0,t[i].vis.render()):t[i].definition&&this.createObjectFromDefinition(t[i]):"capability"===this.options.api&&(t[i].objectId?t[i].vis?(t[i].attached=!0,t[i].vis.render()):this.getObjectFromId(t[i]):t[i].type?this.createObjectWithVisualizationAPI(t[i]):t[i].definition&&t[i].definition.qInfo&&this.createObjectFromDefinition(t[i]))}},{key:"closeObjects",value:function(e){var t=this.options.views[e];if(t&&0<t.length)for(var i=0;i<t.length;i++)t[i].vis?t[i].attached=!1:t[i].objectId&&this.destroyObjectFromId(t[i])}},{key:"getObjectFromId",value:function(e){this.apps[e.app].getObject(e.elementId,e.objectId)}},{key:"createObjectFromDefinition",value:function(t){var i=this,e=void 0;"engine"==this.options.api?e="createSessionObject":"capability"===this.options.api&&(e="createGenericObject"),this.apps[t.app][e](t.definition).then(function(e){t.objectId=e.id,t.attached=!0,-1!==i.supportedChartTypes.indexOf(t.definition.qInfo.qType)?(t.vis=new i.chartLibrary[t.definition.qInfo.qType](t.elementId,e),e.on("changed",function(){!0===t.attached&&t.vis.render()})):t.render&&"function"==typeof t.render&&(t.vis={},t.render.call(t,e),e.on("changed",function(){!0===t.attached&&t.render.call(t,e)}))})}},{key:"createObjectWithVisualizationAPI",value:function(t){this.apps[t.app].visualization.create(t.type,t.columns,t.options).then(function(e){return e.show(t.elementId)})}},{key:"destroyObjectFromId",value:function(e){this.apps[e.app].destroySessionObject(e.elementId,e.objectId)}},{key:"detachObject",value:function(e){e.attached=!1}},{key:"normalizeId",value:function(e){return e.replace(/\s:\\\//,"-")}},{key:"registerVisualisation",value:function(e,t){-1===e.indexOf(/\s/)?-1===this.supportedChartTypes.indexOf(e)?(this.supportedChartTypes.push(e),this.chartLibrary[e]=t):console.log("Failed to register Chart Extension. Chart name already exists."):console.log("Failed to register Chart Extension. Chart name must not contain spaces.")}}]),n}();