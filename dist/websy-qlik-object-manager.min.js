"use strict";var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var WebsyQlikObjectManager=function(){function n(e,t){_classCallCheck(this,n);if(this.apps={},this.supportedChartTypes=[],this.chartLibrary={},this.connectedCallback=t,e.visualisationPlugins&&0<e.visualisationPlugins.length)for(var i=0;i<e.visualisationPlugins.length;i++)this.registerVisualisation(e.visualisationPlugins[i].id,e.visualisationPlugins[i].definition);this.options=Object.assign({},{api:"engine",helpEvent:"mouseover"},e),this.prep(),this.connectToApps()}return _createClass(n,[{key:"buildChildElement",value:function(e,t){var i='<article id="'+e+'_vis" class="websy-vis-article"></article>';return t&&""!==t&&(i+='\n\t\t\t\t<i class="websy-vis-help-listener" data-element="'+e+'"></i>\n\t\t\t\t<div id="'+e+'_help" class="websy-vis-help"><span>'+(t||"")+"</span></div>\n\t\t\t"),i}},{key:"prep",value:function(){var s=this;for(var e in this.options.views)for(var t=0;t<this.options.views[e].length;t++){var i=this.options.views[e][t],n=document.getElementById(i.elementId);n&&(n.innerHTML+=this.buildChildElement(i.elementId,i.help),i.help&&""!==i.help&&(n.addEventListener(this.options.helpEvent,this.handleEvent.bind(this)),n.addEventListener("mouseout",this.handleEvent.bind(this))))}for(var a=function(a){Array.isArray(s.options.actions[a].app)||(s.options.actions[a].app=[s.options.actions[a].app]);var e=document.getElementById(s.options.actions[a].elementId);e&&e.addEventListener(s.options.actions[a].event,function(){for(var e=0;e<s.options.actions[a].app.length;e++){var n=s.apps[s.options.actions[a].app[e]].model;n.enigmaModel&&(n=n.enigmaModel);for(var t=function(e){var t,i=s.options.actions[a].items[e];i.field?n.getField(i.field).then(function(e){e[i.method].apply(e,_toConsumableArray(i.params))}):(t=n)[i.method].apply(t,_toConsumableArray(i.params))},i=0;i<s.options.actions[a].items.length;i++)t(i)}})},o=0;o<this.options.actions.length;o++)a(o)}},{key:"connectToApps",value:function(){var t=this,i=0,e="connectWithEngineAPI";"capability"==this.options.api&&(e="connectWithCapabilityAPI");for(var n=0;n<this.options.apps.length;n++)this[e](this.options.apps[n],function(e){e?t.connectedCallback(e):++i==t.options.apps.length&&(t.connectedCallback(null),t.options.defaultView&&""!==t.options.defaultView&&t.loadObjects(t.options.defaultView))})}},{key:"connectWithCapabilityAPI",value:function(t,i){var n=this,a=t.id;t.id=this.normalizeId(t.id),"undefined"!=typeof require?(require.config({baseUrl:(!0===t.isSecure?"https":"http")+"://"+t.host+":"+t.port+t.prefix+"resources"}),require(["js/qlik"],function(e){n.apps[t.id]=e.openApp(a,t),i()})):i({error:"RequireJs not found."})}},{key:"connectWithEngineAPI",value:function(t,i){var n=this,a=t.id;if(t.id=this.normalizeId(t.id),"undefined"!=typeof enigma){var e={schema:this.options.enigmaSchema,url:(!0===t.isSecure?"wss":"ws")+"://"+t.host+":"+t.port+t.prefix+"app/"+t.id};enigma.create(e).open().then(function(e){e.openDoc(a).then(function(e){n.apps[t.id]=e,i()})})}else i({error:"Enigma.js not found."})}},{key:"loadObjects",value:function(e){var t=this.options.views[e];if(t&&0<t.length)for(var i=0;i<t.length;i++)"engine"===this.options.api?t[i].objectId?(t[i].attached=!0,t[i].vis.render()):t[i].definition&&this.createObjectFromDefinition(t[i]):"capability"===this.options.api&&(t[i].objectId?t[i].vis?(t[i].attached=!0,t[i].vis.render()):this.getObjectFromId(t[i]):t[i].type?this.createObjectWithVisualizationAPI(t[i]):t[i].definition&&t[i].definition.qInfo&&this.createObjectFromDefinition(t[i]))}},{key:"closeObjects",value:function(e){var t=this.options.views[e];if(t&&0<t.length)for(var i=0;i<t.length;i++)t[i].vis?t[i].attached=!1:t[i].objectId&&this.destroyObjectFromId(t[i])}},{key:"getObjectFromId",value:function(e){this.apps[e.app].getObject(e.elementId+"_vis",e.objectId)}},{key:"handleEvent",value:function(e){if(e.target.classList.contains("websy-vis-help-listener")){var t=e.target.attributes["data-element"];t.value&&this.toggleHelp(t.value+"_help")}}},{key:"createObjectFromDefinition",value:function(t){var i=this,e=void 0;"engine"==this.options.api?e="createSessionObject":"capability"===this.options.api&&(e="createGenericObject"),this.apps[t.app][e](t.definition).then(function(e){t.objectId=e.id,t.attached=!0,-1!==i.supportedChartTypes.indexOf(t.definition.qInfo.qType)?(t.vis=new i.chartLibrary[t.definition.qInfo.qType](t.elementId+"_vis",e),e.on("changed",function(){!0===t.attached&&t.vis.render()})):t.render&&"function"==typeof t.render&&(t.vis={},t.render.call(t,e),e.on("changed",function(){!0===t.attached&&t.render.call(t,e)}))})}},{key:"createObjectWithVisualizationAPI",value:function(t){this.apps[t.app].visualization.create(t.type,t.columns,t.options).then(function(e){return e.show(t.elementId+"_vis")})}},{key:"destroyObjectFromId",value:function(e){var t=document.getElementById(e.elementId+"_vis");t&&(t.innerHTML=""),this.apps[e.app].destroySessionObject(e.objectId)}},{key:"detachObject",value:function(e){e.attached=!1}},{key:"normalizeId",value:function(e){return e.replace(/\s:\\\//,"-")}},{key:"showHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.add("active")}},{key:"hideHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.remove("active")}},{key:"toggleHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.toggle("active")}},{key:"registerVisualisation",value:function(e,t){-1===e.indexOf(/\s/)?-1===this.supportedChartTypes.indexOf(e)?(this.supportedChartTypes.push(e),this.chartLibrary[e]=t):console.log("Failed to register Chart Extension. Chart name already exists."):console.log("Failed to register Chart Extension. Chart name must not contain spaces.")}}]),n}();